worker_processes auto;
error_log /var/log/nginx/error.log warn;
pid /var/run/nginx.pid;

events {
    worker_connections 4096;
    use epoll;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;
    
    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for"';
    
    access_log /var/log/nginx/access.log main;
    
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;
    types_hash_max_size 2048;
    client_max_body_size 100M;
    
    # Gzip compression
    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_types text/plain text/css text/xml text/javascript application/json application/javascript application/xml+rss application/rss+xml application/atom+xml image/svg+xml;
    
    # Upstream definitions for all services
    
    # Agent services (8000-8017)
    upstream agent0 { server localhost:8000; }
    upstream agent1 { server localhost:8001; }
    upstream agent2 { server localhost:8002; }
    upstream agent3 { server localhost:8003; }
    upstream agent4 { server localhost:8004; }
    upstream agent5 { server localhost:8005; }
    upstream agent6 { server localhost:8006; }
    upstream agent7 { server localhost:8007; }
    upstream agent8 { server localhost:8008; }
    upstream agent9 { server localhost:8009; }
    upstream agent10 { server localhost:8010; }
    upstream agent11 { server localhost:8011; }
    upstream agent12 { server localhost:8012; }
    upstream agent13 { server localhost:8013; }
    upstream agent14 { server localhost:8014; }
    upstream agent15 { server localhost:8015; }
    upstream agent16 { server localhost:8016; }
    upstream agent17 { server localhost:8017; }
    
    # MCP servers (8100-8109)
    upstream mcp_enhanced { server localhost:8100; }
    upstream mcp_data_std { server localhost:8101; }
    upstream mcp_vector_sim { server localhost:8102; }
    upstream mcp_vector_rank { server localhost:8103; }
    upstream mcp_transport { server localhost:8104; }
    upstream mcp_reasoning { server localhost:8105; }
    upstream mcp_session { server localhost:8106; }
    upstream mcp_streaming { server localhost:8107; }
    upstream mcp_confidence { server localhost:8108; }
    upstream mcp_semantic { server localhost:8109; }
    
    # Core services
    upstream frontend { server localhost:3000; }
    upstream network_api { server localhost:4004; }
    upstream main_service { server localhost:8888; }
    upstream trust_system { server localhost:8020; }
    upstream a2a_registry { server localhost:8090; }
    upstream ord_registry { server localhost:8091; }
    upstream health_dashboard { server localhost:8889; }
    upstream developer_portal { server localhost:3001; }
    upstream api_gateway { server localhost:8080; }
    
    # WebSocket support for notifications
    upstream notifications { server localhost:4006; }
    
    # Main server block
    server {
        listen 80;
        server_name _;
        
        # Default location - main service
        location / {
            proxy_pass http://main_service;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection 'upgrade';
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_cache_bypass $http_upgrade;
        }
        
        # Frontend UI
        location /ui/ {
            proxy_pass http://frontend/;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }
        
        # Agent routes
        location ~ ^/agent([0-9]+)/(.*) {
            set $agent_num $1;
            set $agent_path $2;
            
            if ($agent_num = "0") { proxy_pass http://agent0/$agent_path$is_args$args; }
            if ($agent_num = "1") { proxy_pass http://agent1/$agent_path$is_args$args; }
            if ($agent_num = "2") { proxy_pass http://agent2/$agent_path$is_args$args; }
            if ($agent_num = "3") { proxy_pass http://agent3/$agent_path$is_args$args; }
            if ($agent_num = "4") { proxy_pass http://agent4/$agent_path$is_args$args; }
            if ($agent_num = "5") { proxy_pass http://agent5/$agent_path$is_args$args; }
            if ($agent_num = "6") { proxy_pass http://agent6/$agent_path$is_args$args; }
            if ($agent_num = "7") { proxy_pass http://agent7/$agent_path$is_args$args; }
            if ($agent_num = "8") { proxy_pass http://agent8/$agent_path$is_args$args; }
            if ($agent_num = "9") { proxy_pass http://agent9/$agent_path$is_args$args; }
            if ($agent_num = "10") { proxy_pass http://agent10/$agent_path$is_args$args; }
            if ($agent_num = "11") { proxy_pass http://agent11/$agent_path$is_args$args; }
            if ($agent_num = "12") { proxy_pass http://agent12/$agent_path$is_args$args; }
            if ($agent_num = "13") { proxy_pass http://agent13/$agent_path$is_args$args; }
            if ($agent_num = "14") { proxy_pass http://agent14/$agent_path$is_args$args; }
            if ($agent_num = "15") { proxy_pass http://agent15/$agent_path$is_args$args; }
            if ($agent_num = "16") { proxy_pass http://agent16/$agent_path$is_args$args; }
            if ($agent_num = "17") { proxy_pass http://agent17/$agent_path$is_args$args; }
            
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }
        
        # MCP server routes
        location /mcp/enhanced/ { proxy_pass http://mcp_enhanced/; }
        location /mcp/data-std/ { proxy_pass http://mcp_data_std/; }
        location /mcp/vector-sim/ { proxy_pass http://mcp_vector_sim/; }
        location /mcp/vector-rank/ { proxy_pass http://mcp_vector_rank/; }
        location /mcp/transport/ { proxy_pass http://mcp_transport/; }
        location /mcp/reasoning/ { proxy_pass http://mcp_reasoning/; }
        location /mcp/session/ { proxy_pass http://mcp_session/; }
        location /mcp/streaming/ { proxy_pass http://mcp_streaming/; }
        location /mcp/confidence/ { proxy_pass http://mcp_confidence/; }
        location /mcp/semantic/ { proxy_pass http://mcp_semantic/; }
        
        # Core service routes
        location /api/v1/ { proxy_pass http://network_api/api/v1/; }
        location /trust/ { proxy_pass http://trust_system/; }
        location /registry/ { proxy_pass http://a2a_registry/; }
        location /ord/ { proxy_pass http://ord_registry/; }
        location /dashboard/ { proxy_pass http://health_dashboard/; }
        location /portal/ { proxy_pass http://developer_portal/; }
        location /gateway/ { proxy_pass http://api_gateway/; }
        
        # WebSocket notifications
        location /notifications/ {
            proxy_pass http://notifications/;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }
        
        # Health check endpoint
        location /health {
            access_log off;
            add_header Content-Type text/plain;
            return 200 'healthy';
        }
    }
}