<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>A2A Network - SAP Fiori Launchpad (Fixed)</title>

    <!-- SAP Fiori Shell Configuration - Fixed Bootstrap -->
    <script>
        // Consolidated shell configuration
        window["sap-ushell-config"] = {
            defaultRenderer: "fiori2",
            renderers: {
                fiori2: {
                    componentData: {
                        config: {
                            enableSearch: true,
                            enablePersonalization: true,
                            enableTagFiltering: false,
                            enableCatalogTagFilter: false,
                            enableAbout: true,
                            enableUserDefaultParameters: true,
                            disableSortedLockedGroups: false,
                            enableTileActionsIcon: true,
                            enableSetTheme: true,
                            enableAccessibility: true,
                            enableHelp: true,
                            enableUserImage: false,
                            enableBackGroundShapes: true,
                            animationMode: "minimal",
                            sessionTimeoutReminderInMinutes: 60,
                            sessionTimeoutIntervalInMinutes: 120,
                            sessionTimeoutTileStopRefreshIntervalInMinutes: 90,
                            rootIntent: "Shell-home",
                            preloadLibrariesForRootIntent: false,
                            enableNotificationsUI: true,
                            logo: "/resources/sap/ui/core/mimes/logo/sap_55x27.png",
                            title: "A2A Network - Fixed Shell",
                            moveAppFinderActionToShellHeader: true
                        }
                    }
                }
            },
            applications: {
                "Shell-home": {
                    productSwitch: true
                }
            },
            services: {
                LaunchPage: {
                    adapter: {
                        config: {
                            groups: [
                                {
                                    id: "system_overview_group",
                                    title: "System Overview",
                                    isPreset: true,
                                    isVisible: true,
                                    isGroupLocked: false,
                                    tiles: [
                                        {
                                            id: "network_dashboard",
                                            tileType: "sap.ushell.ui.tile.DynamicTile",
                                            properties: {
                                                title: "Network Dashboard",
                                                subtitle: "System Overview",
                                                icon: "sap-icon://dashboard",
                                                targetURL: "#A2ANetwork-manage&/dashboard",
                                                info: "Real-time Metrics",
                                                serviceUrl: "/launchpad/getNetworkStats",
                                                serviceRefreshInterval: 30
                                            }
                                        },
                                        {
                                            id: "system_health",
                                            tileType: "sap.ushell.ui.tile.DynamicTile",
                                            properties: {
                                                title: "System Health",
                                                subtitle: "Performance Monitor",
                                                icon: "sap-icon://stethoscope",
                                                targetURL: "#A2ANetwork-manage&/health",
                                                info: "Health Status",
                                                serviceUrl: "/launchpad/getHealthSummary",
                                                serviceRefreshInterval: 30
                                            }
                                        }
                                    ]
                                }
                            ],
                            catalogs: []
                        }
                    }
                },
                NavTargetResolution: {
                    adapter: {
                        config: {
                            applications: {
                                "A2ANetwork-manage": {
                                    sap: {
                                        app: {
                                            id: "a2a.network.fiori",
                                            applicationVersion: {
                                                version: "2.0.0"
                                            },
                                            title: "A2A Network Management",
                                            subTitle: "Agent Ecosystem Control",
                                            shortTitle: "A2A Network"
                                        },
                                        ui: {
                                            technology: "UI5",
                                            icons: {
                                                icon: "sap-icon://network-settings"
                                            },
                                            deviceTypes: {
                                                desktop: true,
                                                tablet: true,
                                                phone: true
                                            }
                                        },
                                        ui5: {
                                            componentName: "a2a.network.fiori"
                                        },
                                        flp: {
                                            type: "application"
                                        }
                                    },
                                    url: "./a2aFiori/webapp/",
                                    applicationType: "URL",
                                    navigationMode: "embedded"
                                }
                            }
                        }
                    }
                },
                ClientSideTargetResolution: {
                    adapter: {
                        config: {
                            applications: {
                                "A2ANetwork-manage": {
                                    sap: {
                                        app: {
                                            id: "a2a.network.fiori",
                                            applicationVersion: {
                                                version: "1.0.0-dev"
                                            }
                                        },
                                        flp: {
                                            type: "application"
                                        }
                                    },
                                    url: "./a2aFiori/webapp/",
                                    applicationType: "URL"
                                }
                            }
                        }
                    }
                },
                UserInfo: {
                    adapter: {
                        config: {
                            themes: [
                                { id: "sap_horizon", name: "SAP Horizon" },
                                { id: "sap_horizon_dark", name: "SAP Horizon Dark" },
                                { id: "sap_fiori_3", name: "SAP Quartz Light" },
                                { id: "sap_fiori_3_dark", name: "SAP Quartz Dark" }
                            ]
                        }
                    }
                }
            }
        };

        // Development mode flag
        window.A2A_DEV_MODE = true;
        window.A2A_OFFLINE_MODE = false;
    </script>

    <!-- UI5 Bootstrap -->
    <script
        id="sap-ui-bootstrap"
        src="https://ui5.sap.com/1.120.0/resources/sap-ui-core.js"
        data-sap-ui-theme="sap_horizon"
        data-sap-ui-compatVersion="edge"
        data-sap-ui-frameOptions="allow"
        data-sap-ui-async="true"
        data-sap-ui-preload=""
        data-sap-ui-logLevel="INFO"
        data-sap-ui-resourceroots='{
            "a2a.network.fiori": "./a2aFiori/webapp"
        }'>
    </script>

    <!-- SAP Fiori Launchpad Bootstrap -->
    <script id="sap-ushell-bootstrap" src="https://ui5.sap.com/1.120.0/test-resources/sap/ushell/bootstrap/sandbox.js" 
            data-sap-ui-config='{"xx-bootTask": true}'></script>

    <style>
        body::before {
            content: "FIXED SHELL - DEVELOPMENT MODE";
            position: fixed;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            background: #28a745;
            color: white;
            padding: 2px 10px;
            font-size: 12px;
            z-index: 10000;
            font-family: Arial, sans-serif;
        }
        
        .a2a-error-banner {
            position: fixed;
            top: 30px;
            left: 50%;
            transform: translateX(-50%);
            background: #d93025;
            color: white;
            padding: 10px 20px;
            border-radius: 4px;
            font-size: 14px;
            z-index: 9999;
            display: none;
        }
    </style>
    
    <link rel="stylesheet" type="text/css" href="css/launchpad-sap-compliance.css">
</head>

<body class="sapUiBody" id="content">
    <div id="a2a-error-banner" class="a2a-error-banner">
        CAP Server unavailable. Some tiles may not load properly.
    </div>
    
    <script>
        sap.ui.getCore().attachInit(function() {
            console.log("SAP UI5 Core initialized - Fixed Shell");
            
            // Test CAP server connectivity
            fetch('/launchpad/getNetworkStats', { 
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ id: 'overview_dashboard' })
            })
            .then(response => {
                if (response.ok) {
                    console.log('✅ CAP server is responding');
                } else {
                    throw new Error('CAP server responded with error');
                }
            })
            .catch(error => {
                console.warn('⚠️ CAP server check failed:', error.message);
                window.A2A_OFFLINE_MODE = true;
                const banner = document.getElementById('a2a-error-banner');
                if (banner) {
                    banner.style.display = 'block';
                    setTimeout(() => banner.style.display = 'none', 5000);
                }
            });
            
            sap.ushell.bootstrap("sandbox").then(function() {
                console.log("✅ SAP Shell bootstrap completed - Fixed Version");
                
                sap.ushell.Container.createRenderer("fiori2", true).then(function(oRenderer) {
                    console.log("✅ SAP Shell renderer created - Fixed Configuration");
                    oRenderer.placeAt("content");
                    console.log("🎉 SAP Shell rendered successfully with fixes!");
                }).catch(function(error) {
                    console.error("❌ SAP Shell renderer creation failed:", error);
                    showShellError("Renderer creation failed: " + error.message);
                });
            }).catch(function(error) {
                console.error("❌ SAP Shell bootstrap failed:", error);
                showShellError("Shell bootstrap failed: " + error.message);
            });
        });
        
        function showShellError(message) {
            document.getElementById("content").innerHTML = 
                '<div style="padding: 20px; font-family: Arial;">'+
                '<h2 style="color: #d93025;">SAP Fiori Shell Error (Fixed Version)</h2>'+
                '<p><strong>Error:</strong> ' + message + '</p>'+
                '<p>Please check browser console for details.</p>'+
                '<div style="background: #f8f9fa; padding: 15px; margin: 15px 0; border-left: 4px solid #28a745;">'+
                '<h3 style="color: #28a745; margin-top: 0;">Fixes Applied:</h3>'+
                '<ul>'+
                '<li>✅ Consolidated shell configuration</li>'+
                '<li>✅ Fixed service URL routing</li>'+
                '<li>✅ Added error handling</li>'+
                '<li>✅ Simplified bootstrap sequence</li>'+
                '</ul>'+
                '</div>'+
                '</div>';
        }
    </script>
</body>
</html>
