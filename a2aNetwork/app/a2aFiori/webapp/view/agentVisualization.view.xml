<mvc:View
    controllerName="a2a.network.fiori.controller.AgentVisualization"
    xmlns:mvc="sap.ui.core.mvc"
    xmlns="sap.m"
    xmlns:f="sap.f"
    xmlns:card="sap.f.cards"
    xmlns:w="sap.ui.integration.widgets"
    xmlns:core="sap.ui.core"
    xmlns:suite="sap.suite.ui.microchart"
    xmlns:grid="sap.ui.layout.cssgrid">
    
    <f:DynamicPage id="agentVisualizationPage" class="a2a-tablet-page" headerExpanded="true">
        <f:title>
            <f:DynamicPageTitle>
                <f:heading>
                    <Title text="{i18n>agentNetwork}"/>
                </f:heading>
                <f:expandedContent>
                    <ObjectAttribute title="{i18n>totalAgents}" text="{agentViz>/totalAgents}"/>
                    <ObjectAttribute title="{i18n>activeAgents}" text="{agentViz>/activeAgents}"/>
                    <ObjectAttribute title="{i18n>avgReputation}" text="{agentViz>/avgReputation}"/>
                </f:expandedContent>
                <f:actions>
                    <SegmentedButton selectedKey="{agentViz>/viewMode}">
                        <items>
                            <SegmentedButtonItem key="grid" icon="sap-icon://grid" text="{i18n>gridView}"/>
                            <SegmentedButtonItem key="list" icon="sap-icon://list" text="{i18n>listView}"/>
                            <SegmentedButtonItem key="analytics" icon="sap-icon://chart-table-view" text="{i18n>analyticsView}"/>
                        </items>
                    </SegmentedButton>
                </f:actions>
            </f:DynamicPageTitle>
        </f:title>
        
        <f:header>
            <f:DynamicPageHeader pinnable="true">
                <f:content>
                    <HBox alignItems="Center" justifyContent="SpaceBetween">
                        <items>
                            <!-- Filter Bar -->
                            <VBox>
                                <Label text="{i18n>filterByType}:" labelFor="typeFilter"/>
                                <Select id="typeFilter" selectedKey="{agentViz>/filterType}" change="onFilterChange">
                                    <items>
                                        <core:Item key="all" text="{i18n>allTypes}"/>
                                        <core:Item key="computation" text="{i18n>computation}"/>
                                        <core:Item key="storage" text="{i18n>storage}"/>
                                        <core:Item key="analysis" text="{i18n>analysis}"/>
                                        <core:Item key="communication" text="{i18n>communication}"/>
                                    </items>
                                </Select>
                            </VBox>
                            
                            <VBox>
                                <Label text="{i18n>filterByStatus}:" labelFor="statusFilter"/>
                                <Select id="statusFilter" selectedKey="{agentViz>/filterStatus}" change="onFilterChange">
                                    <items>
                                        <core:Item key="all" text="{i18n>allStatuses}"/>
                                        <core:Item key="active" text="{i18n>active}"/>
                                        <core:Item key="idle" text="{i18n>idle}"/>
                                        <core:Item key="busy" text="{i18n>busy}"/>
                                        <core:Item key="offline" text="{i18n>offline}"/>
                                    </items>
                                </Select>
                            </VBox>
                            
                            <VBox>
                                <Label text="{i18n>minReputation}:" labelFor="repSlider"/>
                                <Slider id="repSlider" 
                                    min="0" 
                                    max="200" 
                                    value="{agentViz>/minReputation}"
                                    liveChange="onFilterChange"
                                    width="200px"
                                    enableTickmarks="true"
                                    inputsAsTooltips="true"/>
                            </VBox>
                        </items>
                    </HBox>
                </f:content>
            </f:DynamicPageHeader>
        </f:header>
        
        <f:content>
            <!-- Loading States -->
            <core:Fragment fragmentName="a2a.network.fiori.fragment.LoadingIndicator" type="XML"/>
            
            <!-- Grid View -->
            <ScrollContainer
                visible="{= ${agentViz>/viewMode} === 'grid'}"
                height="100%"
                width="100%"
                vertical="true">
                <grid:CSSGrid gridTemplateColumns="repeat(auto-fill, minmax(20rem, 1fr))" gridGap="1rem">
                    <grid:items>
                        <!-- Agent Cards using SAP Fiori Card -->
                        <f:Card
                            class="sapUiMediumMarginBottom"
                            visible="{= ${agentViz>/viewMode} === 'grid'}"
                            items="{
                                path: 'agentViz>/agents',
                                templateShareable: false
                            }">
                            <f:header>
                                <card:Header
                                    title="{agentViz>name}"
                                    subtitle="{agentViz>type}"
                                    iconSrc="{= ${agentViz>type} === 'computation' ? 'sap-icon://laptop' : ${agentViz>type} === 'storage' ? 'sap-icon://database' : ${agentViz>type} === 'analysis' ? 'sap-icon://chart-axis' : 'sap-icon://collaborate'}"
                                    statusText="{agentViz>status}"
                                    press="onAgentCardPress"/>
                            </f:header>
                            <f:content>
                                <VBox class="sapUiSmallMargin">
                                    <!-- Performance Metrics -->
                                    <HBox justifyContent="SpaceBetween" class="sapUiTinyMarginBottom">
                                        <VBox>
                                            <Title level="H5" text="{i18n>reputation}"/>
                                            <suite:RadialMicroChart
                                                size="S"
                                                percentage="{= ${agentViz>reputation} / 2}"
                                                valueColor="{
                                                    path: 'agentViz>reputation',
                                                    formatter: '.formatter.formatReputationState'
                                                }"/>
                                            <Text text="{agentViz>reputation}/200"/>
                                        </VBox>
                                        <VBox>
                                            <Title level="H5" text="{i18n>availability}"/>
                                            <suite:HarveyBallMicroChart
                                                size="S"
                                                total="100"
                                                totalScale="%"
                                                formattedLabel="true"
                                                showTotal="false"
                                                items="{
                                                    path: 'agentViz>availability',
                                                    factory: '._createAvailabilityItem'
                                                }"/>
                                            <Text text="{agentViz>availability}%"/>
                                        </VBox>
                                    </HBox>
                                    
                                    <!-- Service Info -->
                                    <VBox class="sapUiTinyMarginTop">
                                        <HBox justifyContent="SpaceBetween">
                                            <Text text="{i18n>services}:"/>
                                            <ObjectNumber number="{agentViz>serviceCount}"/>
                                        </HBox>
                                        <HBox justifyContent="SpaceBetween">
                                            <Text text="{i18n>successRate}:"/>
                                            <ObjectNumber 
                                                number="{agentViz>successRate}" 
                                                unit="%"
                                                state="{= ${agentViz>successRate} > 95 ? 'Success' : ${agentViz>successRate} > 80 ? 'Warning' : 'Error'}"/>
                                        </HBox>
                                        <HBox justifyContent="SpaceBetween">
                                            <Text text="{i18n>avgResponseTime}:"/>
                                            <ObjectNumber number="{agentViz>avgResponseTime}" unit="ms"/>
                                        </HBox>
                                    </VBox>
                                    
                                    <!-- Actions -->
                                    <HBox justifyContent="End" class="sapUiTinyMarginTop">
                                        <Button
                                            text="{i18n>details}"
                                            type="Transparent"
                                            press="onViewDetails"/>
                                        <Button
                                            text="{i18n>interact}"
                                            type="Emphasized"
                                            press="onInteract"
                                            enabled="{= ${agentViz>status} === 'active'}"/>
                                    </HBox>
                                </VBox>
                            </f:content>
                        </f:Card>
                    </grid:items>
                </grid:CSSGrid>
            </ScrollContainer>
            
            <!-- List View -->
            <Table
                visible="{= ${agentViz>/viewMode} === 'list'}"
                items="{
                    path: 'agentViz>/agents',
                    sorter: {
                        path: 'reputation',
                        descending: true
                    }
                }"
                sticky="ColumnHeaders,HeaderToolbar">
                <headerToolbar>
                    <OverflowToolbar>
                        <Title text="{i18n>agentList}" level="H2"/>
                        <ToolbarSpacer/>
                        <SearchField
                            liveChange="onSearch"
                            width="15rem"/>
                        <Button
                            icon="sap-icon://sort"
                            press="onSort"/>
                        <Button
                            icon="sap-icon://excel-attachment"
                            press="onExport"/>
                    </OverflowToolbar>
                </headerToolbar>
                <columns>
                    <Column>
                        <Text text="{i18n>agent}"/>
                    </Column>
                    <Column hAlign="Center">
                        <Text text="{i18n>type}"/>
                    </Column>
                    <Column hAlign="Center">
                        <Text text="{i18n>status}"/>
                    </Column>
                    <Column hAlign="End">
                        <Text text="{i18n>reputation}"/>
                    </Column>
                    <Column hAlign="End">
                        <Text text="{i18n>services}"/>
                    </Column>
                    <Column hAlign="End">
                        <Text text="{i18n>successRate}"/>
                    </Column>
                    <Column hAlign="End">
                        <Text text="{i18n>responseTime}"/>
                    </Column>
                    <Column hAlign="Center">
                        <Text text="{i18n>actions}"/>
                    </Column>
                </columns>
                <items>
                    <ColumnListItem>
                        <cells>
                            <ObjectIdentifier
                                title="{agentViz>name}"
                                text="{
                                    path: 'agentViz>address',
                                    formatter: '.formatter.formatAddress'
                                }"/>
                            <Text text="{agentViz>type}"/>
                            <ObjectStatus
                                text="{agentViz>status}"
                                state="{= ${agentViz>status} === 'active' ? 'Success' : ${agentViz>status} === 'busy' ? 'Warning' : ${agentViz>status} === 'offline' ? 'Error' : 'None'}"/>
                            <ObjectNumber
                                number="{agentViz>reputation}"
                                state="{
                                    path: 'agentViz>reputation',
                                    formatter: '.formatter.formatReputationState'
                                }"/>
                            <ObjectNumber number="{agentViz>serviceCount}"/>
                            <ObjectNumber
                                number="{agentViz>successRate}"
                                unit="%"
                                state="{= ${agentViz>successRate} > 95 ? 'Success' : ${agentViz>successRate} > 80 ? 'Warning' : 'Error'}"/>
                            <ObjectNumber number="{agentViz>avgResponseTime}" unit="ms"/>
                            <HBox>
                                <Button
                                    icon="sap-icon://detail-view"
                                    tooltip="{i18n>viewDetails}"
                                    press="onViewDetails"
                                    type="Transparent"/>
                                <Button
                                    icon="sap-icon://connected"
                                    tooltip="{i18n>interact}"
                                    press="onInteract"
                                    type="Transparent"
                                    enabled="{= ${agentViz>status} === 'active'}"/>
                            </HBox>
                        </cells>
                    </ColumnListItem>
                </items>
            </Table>
            
            <!-- Analytics View -->
            <VBox visible="{= ${agentViz>/viewMode} === 'analytics'}" class="sapUiMediumMargin">
                <grid:CSSGrid gridTemplateColumns="1fr 1fr" gridGap="1rem">
                    <grid:items>
                        <!-- Agent Distribution Chart -->
                        <f:Card>
                            <f:header>
                                <card:Header
                                    title="{i18n>agentDistribution}"
                                    subtitle="{i18n>byType}"/>
                            </f:header>
                            <f:content>
                                <sap.viz:VizFrame
                                    id="agentTypeChart"
                                    uiConfig="{applicationSet:'fiori'}"
                                    vizType="donut"
                                    height="300px"/>
                            </f:content>
                        </f:Card>
                        
                        <!-- Performance Overview -->
                        <f:Card>
                            <f:header>
                                <card:Header
                                    title="{i18n>performanceOverview}"
                                    subtitle="{i18n>top10Agents}"/>
                            </f:header>
                            <f:content>
                                <sap.viz:VizFrame
                                    id="performanceChart"
                                    uiConfig="{applicationSet:'fiori'}"
                                    vizType="column"
                                    height="300px"/>
                            </f:content>
                        </f:Card>
                        
                        <!-- Reputation Distribution -->
                        <f:Card>
                            <f:header>
                                <card:Header
                                    title="{i18n>reputationDistribution}"
                                    subtitle="{i18n>histogram}"/>
                            </f:header>
                            <f:content>
                                <sap.viz:VizFrame
                                    id="reputationChart"
                                    uiConfig="{applicationSet:'fiori'}"
                                    vizType="column"
                                    height="300px"/>
                            </f:content>
                        </f:Card>
                        
                        <!-- Activity Heatmap -->
                        <f:Card>
                            <f:header>
                                <card:Header
                                    title="{i18n>activityHeatmap}"
                                    subtitle="{i18n>last7Days}"/>
                            </f:header>
                            <f:content>
                                <sap.viz:VizFrame
                                    id="activityChart"
                                    uiConfig="{applicationSet:'fiori'}"
                                    vizType="heatmap"
                                    height="300px"/>
                            </f:content>
                        </f:Card>
                    </grid:items>
                </grid:CSSGrid>
            </VBox>
        </f:content>
    </f:DynamicPage>
</mvc:View>