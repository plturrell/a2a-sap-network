<core:FragmentDefinition
    xmlns="sap.m"
    xmlns:core="sap.ui.core"
    xmlns:l="sap.ui.layout">
    
    <Dialog
        id="formulaBuilderDialog"
        title="Formula Builder & Calculator"
        contentWidth="60rem"
        contentHeight="auto"
        resizable="true"
        draggable="true"
        stretch="{device>/system/phone}"
        ariaLabelledBy="formulaBuilderTitle"
        ariaDescribedBy="formulaBuilderHelp"
        class="sapUiResponsiveContentPadding">
        
        <core:InvisibleText id="formulaBuilderTitle" text="Formula Builder and Calculator Dialog"/>
        <core:InvisibleText id="formulaBuilderHelp" text="Build and test mathematical formulas using the editor panel on the left and results panel on the right. Include functions, operators, and variables to create complex calculations."/>
        
        <content>
            <l:Splitter height="100%" orientation="Horizontal">
                <l:contentAreas>
                    <!-- Formula Editor Panel -->
                    <Panel 
                        headerText="Formula Editor" 
                        width="60%"
                        ariaLabelledBy="formulaEditorPanelTitle"
                        class="sapUiResponsiveContentPadding">
                        <core:InvisibleText id="formulaEditorPanelTitle" text="Formula Editor Panel with input area, function library, operators, and variable manager"/>
                        <content>
                            <VBox>
                                <!-- Formula Input -->
                                <VBox class="sapUiMediumMargin">
                                    <Label text="Formula Expression" required="true" labelFor="formulaInput"/>
                                    <TextArea
                                        id="formulaInput"
                                        value="{formula>/currentFormula}"
                                        rows="4"
                                        width="100%"
                                        placeholder="Enter your formula here..."
                                        liveChange=".onFormulaChange"
                                        ariaDescribedBy="formulaInputHelp"
                                        class="sapUiMediumMarginBottom"/>
                                    <core:InvisibleText id="formulaInputHelp" text="Enter mathematical expressions using functions, operators, and variables. Syntax validation is performed in real-time."/>
                                    
                                    <HBox>
                                        <Text 
                                            text="Syntax: Valid"
                                            class="sapUiTinyMarginTop"
                                            visible="{formula>/syntaxValid}"/>
                                        <Text 
                                            text="Syntax Error: {formula>/syntaxError}"
                                            class="sapUiTinyMarginTop sapMObjectStatusError"
                                            visible="{= !${formula>/syntaxValid} }"/>
                                    </HBox>
                                </VBox>
                                
                                <!-- Function Library -->
                                <Panel 
                                    headerText="Function Library"
                                    expandable="true"
                                    expanded="true"
                                    ariaDescribedBy="functionLibraryHelp"
                                    class="sapUiMediumMarginBottom">
                                    <core:InvisibleText id="functionLibraryHelp" text="Available mathematical functions including trigonometric, logarithmic, statistical, and financial functions"/>
                                    <l:Grid 
                                        defaultSpan="L2 M3 S6"
                                        hSpacing="0.25rem"
                                        vSpacing="0.25rem">
                                        <Button 
                                            text="{formula>}"
                                            press=".onAddFunction"
                                            class="sapUiTinyMargin"
                                            ariaDescribedBy="functionButtonHelp"/>
                                    </l:Grid>
                                    <core:InvisibleText id="functionButtonHelp" text="Click to insert function into formula expression"/>
                                </Panel>
                                
                                <!-- Operators -->
                                <Panel 
                                    headerText="Operators"
                                    expandable="true"
                                    expanded="true"
                                    ariaDescribedBy="operatorsHelp"
                                    class="sapUiMediumMarginBottom">
                                    <core:InvisibleText id="operatorsHelp" text="Mathematical operators including arithmetic, comparison, and logical operators"/>
                                    <l:Grid 
                                        defaultSpan="L1 M2 S3"
                                        hSpacing="0.25rem"
                                        vSpacing="0.25rem">
                                        <Button 
                                            text="{formula>}"
                                            press=".onAddOperator"
                                            class="sapUiTinyMargin"
                                            ariaDescribedBy="operatorButtonHelp"/>
                                    </l:Grid>
                                    <core:InvisibleText id="operatorButtonHelp" text="Click to insert operator into formula expression"/>
                                </Panel>
                                
                                <!-- Variable Manager -->
                                <Panel 
                                    headerText="Variables"
                                    expandable="true"
                                    expanded="false">
                                    <VBox>
                                        <Toolbar ariaLabelledBy="variableToolbarLabel">
                                            <core:InvisibleText id="variableToolbarLabel" text="Add new variable with name and default value"/>
                                            <Input 
                                                id="newVariableName"
                                                placeholder="Variable name"
                                                width="150px"
                                                ariaLabelledBy="newVariableNameLabel"/>
                                            <Label id="newVariableNameLabel" text="Variable name" visible="false"/>
                                            <Input 
                                                id="newVariableValue"
                                                placeholder="Default value"
                                                type="Number"
                                                width="100px"
                                                ariaLabelledBy="newVariableValueLabel"/>
                                            <Label id="newVariableValueLabel" text="Default value" visible="false"/>
                                            <Button 
                                                text="Add"
                                                press=".onAddVariable"
                                                tooltip="Add new variable to formula"/>
                                        </Toolbar>
                                        
                                        <Table
                                            items="{formula>/variables}"
                                            mode="Delete">
                                            <columns>
                                                <Column><Text text="Name"/></Column>
                                                <Column><Text text="Value"/></Column>
                                                <Column><Text text="Type"/></Column>
                                            </columns>
                                            <items>
                                                <ColumnListItem>
                                                    <cells>
                                                        <Text text="{formula>name}"/>
                                                        <Input 
                                                            value="{formula>value}"
                                                            type="Number"/>
                                                        <Text text="{formula>type}"/>
                                                    </cells>
                                                </ColumnListItem>
                                            </items>
                                        </Table>
                                    </VBox>
                                </Panel>
                            </VBox>
                        </content>
                    </Panel>
                    
                    <!-- Testing & Results Panel -->
                    <Panel 
                        headerText="Testing & Results" 
                        width="40%"
                        ariaLabelledBy="testingPanelTitle"
                        class="sapUiResponsiveContentPadding">
                        <core:InvisibleText id="testingPanelTitle" text="Testing and Results Panel with test execution, results display, examples, and formula history"/>
                        <content>
                            <VBox class="sapUiMediumMargin">
                                <!-- Quick Test -->
                                <VBox class="sapUiMediumMarginBottom">
                                    <Label text="Quick Test" labelFor="testFormulaButton"/>
                                    <Button 
                                        id="testFormulaButton"
                                        text="Test Formula"
                                        type="Emphasized"
                                        press=".onTestFormula"
                                        enabled="{formula>/syntaxValid}"
                                        tooltip="Execute formula test with current variables"
                                        ariaDescribedBy="testFormulaHelp"/>
                                    <core:InvisibleText id="testFormulaHelp" text="Test the current formula expression with defined variables and view results in the table below"/>
                                </VBox>
                                
                                <!-- Test Results -->
                                <Panel 
                                    headerText="Test Results"
                                    class="sapUiMediumMarginTop">
                                    <Table
                                        items="{formula>/testResults}"
                                        mode="None">
                                        <columns>
                                            <Column><Text text="Input"/></Column>
                                            <Column><Text text="Result"/></Column>
                                            <Column><Text text="Status"/></Column>
                                        </columns>
                                        <items>
                                            <ColumnListItem>
                                                <cells>
                                                    <Text text="{formula>input}"/>
                                                    <Text text="{formula>result}"/>
                                                    <ObjectStatus 
                                                        text="{formula>status}"
                                                        state="{= ${formula>status} === 'PASS' ? 'Success' : 'Error' }"/>
                                                </cells>
                                            </ColumnListItem>
                                        </items>
                                    </Table>
                                </Panel>
                                
                                <!-- Formula Examples -->
                                <Panel 
                                    headerText="Examples"
                                    expandable="true"
                                    expanded="false"
                                    class="sapUiMediumMarginTop">
                                    <List>
                                        <StandardListItem
                                            title="Compound Interest"
                                            description="P * (1 + r/n)^(n*t)"
                                            press=".onLoadExample"/>
                                        <StandardListItem
                                            title="Quadratic Formula"
                                            description="(-b + SQRT(b^2 - 4*a*c)) / (2*a)"
                                            press=".onLoadExample"/>
                                        <StandardListItem
                                            title="Normal Distribution"
                                            description="(1/SQRT(2*PI*σ²))*EXP(-0.5*((x-μ)/σ)²)"
                                            press=".onLoadExample"/>
                                        <StandardListItem
                                            title="Black-Scholes"
                                            description="S*N(d1) - K*EXP(-r*T)*N(d2)"
                                            press=".onLoadExample"/>
                                    </List>
                                </Panel>
                                
                                <!-- Formula History -->
                                <Panel 
                                    headerText="Recent Formulas"
                                    expandable="true"
                                    expanded="false"
                                    class="sapUiMediumMarginTop">
                                    <List items="{formula>/history}">
                                        <StandardListItem
                                            title="{formula>expression}"
                                            description="{formula>timestamp}"
                                            press=".onLoadFromHistory"/>
                                    </List>
                                </Panel>
                            </VBox>
                        </content>
                    </Panel>
                </l:contentAreas>
            </l:Splitter>
        </content>
        
        <beginButton>
            <Button text="Clear" press=".onClearFormula"/>
        </beginButton>
        
        <endButton>
            <Button 
                text="Use Formula"
                type="Emphasized"
                press=".onUseFormula"
                enabled="{formula>/syntaxValid}"/>
        </endButton>
        
    </Dialog>
    
</core:FragmentDefinition>