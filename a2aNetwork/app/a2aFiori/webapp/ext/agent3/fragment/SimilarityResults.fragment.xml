<core:FragmentDefinition
    xmlns="sap.m"
    xmlns:core="sap.ui.core"
    xmlns:table="sap.ui.table">
    
    <Dialog
        id="similarityResultsDialog"
        title="Similarity Search Results"
        contentWidth="95%"
        contentHeight="85%"
        resizable="true"
        draggable="true">
        
        <content>
            <VBox>
                <!-- Search Summary -->
                <Panel headerText="Search Summary" class="sapUiResponsiveMargin">
                    <HBox class="sapUiMediumMargin">
                        <VBox class="sapUiMediumMarginEnd">
                            <Title text="Results Found" level="H3"/>
                            <ObjectNumber 
                                number="{path: 'results>/totalResults', formatter: '.formatSecureText'}" 
                                state="Success"
                                emphasized="true"/>
                        </VBox>
                        <VBox class="sapUiMediumMarginEnd">
                            <Title text="Search Time" level="H3"/>
                            <ObjectNumber 
                                number="{path: 'results>/searchTime', formatter: '.formatSecureText'}" 
                                unit="ms"
                                state="None"/>
                        </VBox>
                        <VBox class="sapUiMediumMarginEnd">
                            <Title text="Best Score" level="H3"/>
                            <ObjectNumber 
                                number="{path: 'results>/bestScore', formatter: '.formatSecureText'}" 
                                state="Success"/>
                        </VBox>
                        <VBox>
                            <Title text="Collection" level="H3"/>
                            <Text text="{path: 'results>/collection', formatter: '.formatSecureText'}"/>
                        </VBox>
                    </HBox>
                </Panel>
                
                <!-- Filter and Sort Controls -->
                <Panel headerText="Filter & Sort" expandable="true" expanded="false">
                    <HBox class="sapUiMediumMargin">
                        <VBox class="sapUiMediumMarginEnd">
                            <Label text="Minimum Score" labelFor="minScoreSlider"/>
                            <Slider 
                                id="minScoreSlider"
                                value="{results>/minScore}"
                                min="0"
                                max="1"
                                step="0.01"
                                width="200px"
                                liveChange=".onFilterResults"
                                ariaLabel="Minimum similarity score filter"/>
                        </VBox>
                        <VBox class="sapUiMediumMarginEnd">
                            <Label text="Sort By" labelFor="sortBySelect"/>
                            <Select 
                                id="sortBySelect"
                                selectedKey="{results>/sortBy}" 
                                change=".onSortResults"
                                ariaLabel="Sort results by attribute">
                                <items>
                                    <core:Item key="score" text="Similarity Score"/>
                                    <core:Item key="distance" text="Distance"/>
                                    <core:Item key="content_length" text="Content Length"/>
                                    <core:Item key="metadata.timestamp" text="Timestamp"/>
                                </items>
                            </Select>
                        </VBox>
                        <VBox class="sapUiMediumMarginEnd">
                            <Label text="Order" labelFor="sortOrderGroup"/>
                            <RadioButtonGroup 
                                id="sortOrderGroup"
                                selectedIndex="{results>/sortOrder}"
                                ariaLabel="Sort order direction">
                                <RadioButton text="Descending"/>
                                <RadioButton text="Ascending"/>
                            </RadioButtonGroup>
                        </VBox>
                        <VBox>
                            <Label text=" "/>
                            <Button 
                                text="Apply Filters"
                                press=".onApplyResultFilters"
                                ariaLabel="Apply filter and sort settings"/>
                        </VBox>
                    </HBox>
                </Panel>
                
                <!-- Results Table -->
                <table:Table
                    rows="{results>/searchResults}"
                    selectionMode="MultiToggle"
                    visibleRowCount="15"
                    enableColumnReordering="true"
                    class="sapUiResponsiveMargin">
                    
                    <table:extension>
                        <Toolbar>
                            <Title text="Search Results ({results>/filteredCount} of {results>/totalResults})"/>
                            <ToolbarSpacer/>
                            <Button 
                                text="Export Results"
                                icon="sap-icon://download"
                                press=".onExportResults"
                                ariaLabel="Export search results"/>
                            <Button 
                                text="Create Collection"
                                icon="sap-icon://create"
                                press=".onCreateCollectionFromResults"
                                enabled="{= ${results>/selectedResults} > 0}"
                                ariaLabel="Create collection from selected results"/>
                            <Button 
                                text="View in 3D"
                                icon="sap-icon://dimension"
                                press=".onVisualize3D"
                                ariaLabel="Visualize results in 3D space"/>
                        </Toolbar>
                    </table:extension>
                    
                    <table:columns>
                        <table:Column width="60px" sortProperty="rank">
                            <Label text="Rank"/>
                            <table:template>
                                <Text text="{path: 'results>rank', formatter: '.formatSecureText'}"/>
                            </table:template>
                        </table:Column>
                        
                        <table:Column width="100px" sortProperty="similarityScore">
                            <Label text="Score"/>
                            <table:template>
                                <ObjectNumber 
                                    number="{path: 'results>similarityScore', formatter: '.formatSecureText'}" 
                                    state="{parts: ['results>similarityScore'], formatter: '.formatScoreState'}"
                                    emphasized="true"/>
                            </table:template>
                        </table:Column>
                        
                        <table:Column width="80px" sortProperty="distance">
                            <Label text="Distance"/>
                            <table:template>
                                <Text text="{path: 'results>distance', formatter: '.formatSecureText'}"/>
                            </table:template>
                        </table:Column>
                        
                        <table:Column sortProperty="resultContent">
                            <Label text="Content"/>
                            <table:template>
                                <VBox>
                                    <FormattedText 
                                        htmlText="{path: 'results>resultContent', formatter: '.formatSecureText'}"
                                        class="sapUiTinyMarginBottom"/>
                                    <Text 
                                        text="ID: {path: 'results>resultVectorId', formatter: '.formatSecureText'}"
                                        class="sapThemeTextSubtle"/>
                                </VBox>
                            </table:template>
                        </table:Column>
                        
                        <table:Column width="150px" sortProperty="contentType">
                            <Label text="Type"/>
                            <table:template>
                                <VBox>
                                    <Text text="{path: 'results>contentType', formatter: '.formatSecureText'}"/>
                                    <Text 
                                        text="Source: {path: 'results>source', formatter: '.formatSecureText'}"
                                        class="sapThemeTextSubtle"/>
                                </VBox>
                            </table:template>
                        </table:Column>
                        
                        <table:Column width="200px">
                            <Label text="Metadata"/>
                            <table:template>
                                <VBox>
                                    <Text text="Created: {path: 'results>created', formatter: '.formatSecureText'}"/>
                                    <Text text="Tags: {path: 'results>tags', formatter: '.formatSecureText'}"/>
                                    <Text text="Category: {path: 'results>category', formatter: '.formatSecureText'}"/>
                                </VBox>
                            </table:template>
                        </table:Column>
                        
                        <table:Column width="120px">
                            <Label text="Actions"/>
                            <table:template>
                                <HBox>
                                    <Button 
                                        icon="sap-icon://detail-view"
                                        tooltip="View Details"
                                        press=".onViewResultDetails"
                                        type="Transparent"
                                        ariaLabel="View detailed information"/>
                                    <Button 
                                        icon="sap-icon://copy"
                                        tooltip="Copy Content"
                                        press=".onCopyContent"
                                        type="Transparent"
                                        ariaLabel="Copy content to clipboard"/>
                                    <Button 
                                        icon="sap-icon://share-2"
                                        tooltip="Find Similar"
                                        press=".onFindSimilar"
                                        type="Transparent"
                                        ariaLabel="Find similar vectors"/>
                                </HBox>
                            </table:template>
                        </table:Column>
                    </table:columns>
                </table:Table>
                
                <!-- Result Analytics -->
                <Panel 
                    headerText="Result Analytics"
                    expandable="true" 
                    expanded="false"
                    class="sapUiResponsiveMargin">
                    <HBox class="sapUiMediumMargin">
                        <VBox class="sapUiMediumMarginEnd">
                            <Title text="Score Distribution" level="H4"/>
                            <Text text="Average: {path: 'results>/avgScore', formatter: '.formatSecureText'}"/>
                            <Text text="Median: {path: 'results>/medianScore', formatter: '.formatSecureText'}"/>
                            <Text text="Std Dev: {path: 'results>/scoreStdDev', formatter: '.formatSecureText'}"/>
                        </VBox>
                        <VBox class="sapUiMediumMarginEnd">
                            <Title text="Content Types" level="H4"/>
                            <List items="{results>/contentTypeDistribution}">
                                <StandardListItem 
                                    title="{path: 'type', formatter: '.formatSecureText'}"
                                    info="{path: 'count', formatter: '.formatSecureText'}"
                                    infoState="None"/>
                            </List>
                        </VBox>
                        <VBox>
                            <Title text="Quality Metrics" level="H4"/>
                            <Text text="Diversity Index: {path: 'results>/diversityIndex', formatter: '.formatSecureText'}"/>
                            <Text text="Coverage: {path: 'results>/coverage', formatter: '.formatSecureText'}%"/>
                            <Text text="Precision@5: {path: 'results>/precisionAt5', formatter: '.formatSecureText'}"/>
                        </VBox>
                    </HBox>
                </Panel>
                
                <!-- Refinement Suggestions -->
                <Panel 
                    headerText="Search Refinement Suggestions"
                    expandable="true" 
                    expanded="false"
                    class="sapUiResponsiveMargin"
                    visible="{= ${results>/suggestions}.length > 0}">
                    <List items="{results>/suggestions}">
                        <ActionListItem 
                            text="{path: 'suggestion', formatter: '.formatSecureText'}"
                            press=".onApplySuggestion"
                            type="Active">
                            <firstAction>
                                <Button 
                                    icon="sap-icon://search"
                                    tooltip="Apply this suggestion"
                                    press=".onApplySuggestion"
                                    ariaLabel="Apply search suggestion"/>
                            </firstAction>
                        </ActionListItem>
                    </List>
                </Panel>
            </VBox>
        </content>
        
        <buttons>
            <Button 
                text="New Search"
                icon="sap-icon://search"
                press=".onNewSearch"
                ariaLabel="Start new search"/>
            <Button 
                text="Save Results"
                icon="sap-icon://save"
                press=".onSaveResults"
                ariaLabel="Save search results"/>
            <Button 
                text="Close"
                press=".onCloseResults"
                ariaLabel="Close results dialog"/>
        </buttons>
        
    </Dialog>
    
</core:FragmentDefinition>