<core:FragmentDefinition
    xmlns="sap.m"
    xmlns:core="sap.ui.core"
    xmlns:form="sap.ui.layout.form">
    
    <Dialog
        id="similaritySearchDialog"
        title="Vector Similarity Search"
        contentWidth="70%"
        contentHeight="60%"
        resizable="true"
        draggable="true">
        
        <content>
            <form:SimpleForm
                editable="true"
                layout="ResponsiveGridLayout"
                labelSpanXL="3"
                labelSpanL="3"
                labelSpanM="12"
                labelSpanS="12"
                adjustLabelSpan="false"
                columnsXL="1"
                columnsL="1"
                columnsM="1">
                
                <form:content>
                    <Label text="Query Type" required="true"/>
                    <RadioButtonGroup selectedIndex="{similarity>/queryType}">
                        <RadioButton text="Text Query"/>
                        <RadioButton text="Vector Query"/>
                        <RadioButton text="Hybrid Search"/>
                    </RadioButtonGroup>
                    
                    <!-- Text Query Section -->
                    <VBox visible="{= ${similarity>/queryType} === 0 }">
                        <Label text="Search Query" required="true"/>
                        <TextArea 
                            value="{similarity>/query}"
                            rows="3"
                            placeholder="Enter your search query..."
                            liveChange=".onQueryChange"/>
                        <CheckBox 
                            text="Use semantic expansion"
                            selected="{similarity>/useSemanticExpansion}"/>
                    </VBox>
                    
                    <!-- Vector Query Section -->
                    <VBox visible="{= ${similarity>/queryType} === 1 }">
                        <Label text="Vector Input"/>
                        <TextArea 
                            value="{similarity>/vectorQuery}"
                            rows="4"
                            placeholder="Enter vector as comma-separated values: 0.1, 0.2, -0.3, ..."
                            liveChange=".onVectorQueryChange"/>
                        <Text text="Expected dimensions: {similarity>/expectedDimensions}"/>
                    </VBox>
                    
                    <!-- Hybrid Search Section -->
                    <VBox visible="{= ${similarity>/queryType} === 2 }">
                        <Label text="Text Component"/>
                        <TextArea 
                            value="{similarity>/query}"
                            rows="2"
                            placeholder="Text query component"/>
                        <Label text="Vector Component"/>
                        <TextArea 
                            value="{similarity>/vectorQuery}"
                            rows="2"
                            placeholder="Vector component"/>
                        <HBox>
                            <Label text="Text Weight:" width="100px"/>
                            <Slider 
                                value="{similarity>/textWeight}"
                                min="0"
                                max="1"
                                step="0.1"
                                width="200px"/>
                            <Text text="{similarity>/textWeight}"/>
                        </HBox>
                    </VBox>
                    
                    <Label text="Collection" required="true"/>
                    <Select 
                        selectedKey="{similarity>/collection}"
                        change=".onCollectionChange">
                        <items>
                            <core:Item key="" text="Select collection..."/>
                        </items>
                    </Select>
                    
                    <Label text="Search Parameters"/>
                    <VBox>
                        <HBox>
                            <Label text="Top K Results:" width="120px"/>
                            <Input 
                                value="{similarity>/topK}"
                                type="Number"
                                width="80px"/>
                        </HBox>
                        <HBox class="sapUiTinyMarginTop">
                            <Label text="Similarity Threshold:" width="120px"/>
                            <Slider 
                                value="{similarity>/similarityThreshold}"
                                min="0"
                                max="1"
                                step="0.01"
                                width="200px"/>
                            <Text text="{similarity>/similarityThreshold}" class="sapUiTinyMarginBegin"/>
                        </HBox>
                    </VBox>
                    
                    <Label text="Output Options"/>
                    <VBox>
                        <CheckBox 
                            text="Include metadata"
                            selected="{similarity>/includeMetadata}"/>
                        <CheckBox 
                            text="Include distances"
                            selected="{similarity>/includeDistance}"/>
                        <CheckBox 
                            text="Include vectors"
                            selected="{similarity>/includeVectors}"/>
                        <CheckBox 
                            text="Sort by relevance"
                            selected="{similarity>/sortByRelevance}"/>
                    </VBox>
                    
                    <Label text="Filters (Optional)"/>
                    <VBox>
                        <HBox>
                            <Input 
                                placeholder="Filter field"
                                value="{similarity>/filterField}"
                                width="150px"
                                class="sapUiTinyMarginEnd"/>
                            <Select 
                                selectedKey="{similarity>/filterOperator}"
                                width="100px"
                                class="sapUiTinyMarginEnd">
                                <items>
                                    <core:Item key="eq" text="Equals"/>
                                    <core:Item key="ne" text="Not Equals"/>
                                    <core:Item key="gt" text="Greater Than"/>
                                    <core:Item key="lt" text="Less Than"/>
                                    <core:Item key="contains" text="Contains"/>
                                    <core:Item key="in" text="In"/>
                                </items>
                            </Select>
                            <Input 
                                placeholder="Filter value"
                                value="{similarity>/filterValue}"
                                width="150px"
                                class="sapUiTinyMarginEnd"/>
                            <Button 
                                icon="sap-icon://add"
                                tooltip="Add filter"
                                press=".onAddFilter"/>
                        </HBox>
                        
                        <!-- Active Filters -->
                        <List 
                            items="{similarity>/activeFilters}"
                            visible="{= ${similarity>/activeFilters}.length > 0}">
                            <StandardListItem 
                                title="{field} {operator} {value}"
                                press=".onRemoveFilter"
                                type="Active"
                                icon="sap-icon://delete"/>
                        </List>
                    </VBox>
                    
                    <Label text="Advanced Options"/>
                    <VBox>
                        <CheckBox 
                            text="Enable re-ranking"
                            selected="{similarity>/enableReranking}"/>
                        <HBox visible="{similarity>/enableReranking}">
                            <Label text="Re-ranking model:" width="120px"/>
                            <Select selectedKey="{similarity>/rerankingModel}" width="200px">
                                <items>
                                    <core:Item key="cohere-rerank-v3" text="Cohere Rerank v3"/>
                                    <core:Item key="cross-encoder" text="Cross Encoder"/>
                                    <core:Item key="bge-reranker" text="BGE Reranker"/>
                                </items>
                            </Select>
                        </HBox>
                        
                        <CheckBox 
                            text="Use approximate search (faster)"
                            selected="{similarity>/useApproximateSearch}"/>
                        
                        <HBox>
                            <Label text="Search timeout:" width="120px"/>
                            <Input 
                                value="{similarity>/searchTimeout}"
                                type="Number"
                                width="80px"/>
                            <Text text="seconds" class="sapUiTinyMarginBegin"/>
                        </HBox>
                    </VBox>
                </form:content>
            </form:SimpleForm>
            
            <!-- Search Preview -->
            <Panel 
                headerText="Search Preview"
                expandable="true"
                expanded="false"
                class="sapUiResponsiveMargin">
                <VBox class="sapUiMediumMargin">
                    <Text text="Collection: {similarity>/collection}"/>
                    <Text text="Query: {similarity>/query}"/>
                    <Text text="Expected results: {similarity>/topK}"/>
                    <Text text="Estimated processing time: {similarity>/estimatedTime}ms"/>
                </VBox>
            </Panel>
        </content>
        
        <beginButton>
            <Button 
                text="Cancel"
                press=".onCancelSimilaritySearch"/>
        </beginButton>
        
        <endButton>
            <Button 
                text="Search"
                type="Emphasized"
                press=".onExecuteSimilaritySearch"
                enabled="{= (${similarity>/query} || ${similarity>/vectorQuery}) && ${similarity>/collection} }"/>
        </endButton>
        
    </Dialog>
    
</core:FragmentDefinition>