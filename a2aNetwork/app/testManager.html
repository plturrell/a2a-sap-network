<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <title>A2A Test Manager - SAP Enterprise Standard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- Configuration -->
    <script src="./config.js"></script>
    
    <!-- SAP UI5 Bootstrap -->
    <script id="sap-ui-bootstrap"
        src="https://ui5.sap.com/1.120.0/resources/sap-ui-core.js"
        data-sap-ui-libs="sap.m,sap.ui.core,sap.ui.table,sap.f,sap.suite.ui.commons,sap.viz,sap.ushell,sap.fe,sap.ui.comp"
        data-sap-ui-theme="sap_horizon"
        data-sap-ui-compatVersion="edge"
        data-sap-ui-async="true"
        data-sap-ui-resourceroots='{
            "testmanager": "./testmanager/"
        }'>
    </script>

    <!-- Test Manager Application -->
    <script>
        sap.ui.getCore().attachInit(function() {
            sap.ui.require([
                "sap/m/App",
                "sap/m/Page",
                "sap/m/Panel",
                "sap/m/VBox",
                "sap/m/HBox",
                "sap/m/Button",
                "sap/m/Text",
                "sap/m/Title",
                "sap/m/ObjectStatus",
                "sap/m/ProgressIndicator",
                "sap/m/Table",
                "sap/m/Column",
                "sap/m/ColumnListItem",
                "sap/m/Label",
                "sap/m/ComboBox",
                "sap/m/DatePicker",
                "sap/m/MessageBox",
                "sap/m/MessageToast",
                "sap/m/BusyIndicator",
                "sap/m/SearchField",
                "sap/m/ToolbarSpacer",
                "sap/m/Toolbar",
                "sap/m/MenuButton",
                "sap/m/Menu",
                "sap/m/MenuItem",
                "sap/m/Dialog",
                "sap/m/Bar",
                "sap/f/Card",
                "sap/f/cards/Header",
                "sap/f/cards/NumericHeader",
                "sap/f/GridContainer",
                "sap/f/GridContainerItemLayoutData",
                "sap/f/Avatar",
                "sap/ui/core/Item",
                "sap/ui/core/Fragment",
                "sap/ui/model/json/JSONModel",
                "sap/ui/model/Filter",
                "sap/ui/model/FilterOperator",
                "sap/suite/ui/commons/TileContent",
                "sap/suite/ui/commons/NumericTile",
                "sap/viz/ui5/controls/VizFrame",
                "sap/viz/ui5/controls/common/feeds/FeedItem",
                "sap/viz/ui5/data/FlattenedDataset",
                "sap/viz/ui5/data/DimensionDefinition",
                "sap/viz/ui5/data/MeasureDefinition",
                "sap/ushell/services/Container",
                "sap/fe/core/helpers/ClassSupport"
            ], function(
                App, Page, Panel, VBox, HBox, Button, Text, Title, ObjectStatus, ProgressIndicator,
                Table, Column, ColumnListItem, Label, ComboBox, DatePicker, MessageBox, MessageToast, BusyIndicator,
                SearchField, ToolbarSpacer, Toolbar, MenuButton, Menu, MenuItem, Dialog, Bar,
                Card, Header, NumericHeader, GridContainer, GridContainerItemLayoutData, Avatar,
                Item, Fragment, JSONModel, Filter, FilterOperator, TileContent, NumericTile,
                VizFrame, FeedItem, FlattenedDataset, DimensionDefinition, MeasureDefinition, Container, ClassSupport
            ) {

                // Test Manager Controller
                const TestManagerController = {
                    testApiUrl: '/api/test',
                    websocket: null,
                    userProfile: {
                        name: 'Test Manager User',
                        role: 'Administrator',
                        permissions: ['run_tests', 'view_reports', 'manage_config']
                    },
                    
                    // Initialize the application
                    onInit: function() {
                        this.setupModel();
                        this.createUI();
                        this.loadTestData();
                        this.initializeWebSocket();
                        this.setupUserProfile();
                        this.setupAutoRefresh();
                    },

                    // Setup data model
                    setupModel: function() {
                        const data = {
                            testRuns: [],
                            statistics: {
                                totalRuns: 0,
                                successRate: 0,
                                avgDuration: 0,
                                totalTests: 0
                            },
                            testGroups: [],
                            chartData: [],
                            userProfile: this.userProfile,
                            filters: { environment: '', status: '', dateRange: '' },
                            realTimeUpdates: true,
                            notifications: [],
                            currentRun: null,
                            isRunning: false
                        };

                        this.oModel = new JSONModel(data);
                        sap.ui.getCore().setModel(this.oModel);
                    },

                    // Create main UI
                    createUI: function() {
                        // Main Application
                        const oApp = new App("testManagerApp", {
                            pages: [this.createMainPage()]
                        });

                        // Place in DOM
                        oApp.placeAt("content");
                    },

                    // Create main page
                    createMainPage: function() {
                        return new Page("mainPage", {
                            title: "A2A Test Control Tower - Enterprise Standard",
                            showHeader: true,
                            headerContent: [
                                new Avatar({
                                    displaySize: "S",
                                    initials: this.userProfile.name.split(' ').map(n => n[0]).join(''),
                                    backgroundColor: "Accent1"
                                }),
                                new Text({
                                    text: this.userProfile.name + " (" + this.userProfile.role + ")",
                                    class: "sapUiTinyMarginBegin"
                                })
                            ],
                            content: [
                                this.createToolbar(),
                                this.createKPIDashboard(),
                                this.createChartsPanel(),
                                this.createAdvancedTestGroupsPanel(),
                                this.createEnhancedTestRunsPanel()
                            ],
                            footer: this.createFooterToolbar()
                        });
                    },

                    // Create toolbar
                    createToolbar: function() {
                        return new Toolbar("mainToolbar", {
                            content: [
                                new Title({
                                    text: "Test Control Tower - A2A Launchpad Components",
                                    level: "H2"
                                }),
                                new ToolbarSpacer(),
                                new SearchField({
                                    placeholder: "Search tests, runs, or components...",
                                    width: "20rem",
                                    search: this.onSearch.bind(this)
                                }),
                                new MenuButton({
                                    text: "Actions",
                                    icon: "sap-icon://action",
                                    menu: new Menu({
                                        items: [
                                            new MenuItem({ text: "Run All Tests", icon: "sap-icon://play", press: this.onRunAllTests.bind(this) }),
                                            new MenuItem({ text: "Schedule Test Run", icon: "sap-icon://appointment-2", press: this.onScheduleTest.bind(this) }),
                                            new MenuItem({ text: "Export Results", icon: "sap-icon://download", press: this.onExportResults.bind(this) }),
                                            new MenuItem({ text: "Configuration", icon: "sap-icon://settings", press: this.onConfiguration.bind(this) })
                                        ]
                                    })
                                }),
                                new Button({
                                    icon: "sap-icon://refresh",
                                    tooltip: "Refresh Data",
                                    press: this.onRefresh.bind(this)
                                }),
                                new Button({
                                    icon: "sap-icon://notification-2",
                                    tooltip: "Notifications",
                                    text: "{/notifications/length}",
                                    press: this.onShowNotifications.bind(this)
                                })
                            ],
                            class: "sapUiMediumMargin"
                        });
                    },

                    // Create KPI Dashboard
                    createKPIDashboard: function() {
                        return new Panel("kpiDashboard", {
                            headerText: "Real-Time KPI Dashboard",
                            class: "sapUiMediumMargin",
                            content: [
                                new GridContainer("kpiGrid", {
                                    layout: {
                                        columnSize: "15.25rem",
                                        rowSize: "5rem",
                                        gap: "1rem"
                                    },
                                    items: [
                                        this.createKPICard("Total Runs", "{/statistics/totalRuns}", "sap-icon://number-sign", "Success", "2,4"),
                                        this.createKPICard("Success Rate", "{/statistics/successRate}%", "sap-icon://status-positive", "Success", "2,4"),
                                        this.createKPICard("Avg Duration", "{/statistics/avgDuration}s", "sap-icon://time-overtime", "Information", "2,4"),
                                        this.createKPICard("Active Tests", "{/statistics/totalTests}", "sap-icon://checklist", "Information", "2,4"),
                                        this.createKPICard("Coverage", "89.3%", "sap-icon://pie-chart", "Success", "2,4"),
                                        this.createKPICard("Environments", "4", "sap-icon://cluster", "Information", "2,4")
                                    ]
                                })
                            ]
                        });
                    },

                    // Create KPI Card
                    createKPICard: function(title, value, icon, state, layoutData) {
                        return new Card({
                            class: "sapUiTinyMargin kpiCard",
                            layoutData: new GridContainerItemLayoutData({
                                columns: parseInt(layoutData.split(',')[0]),
                                rows: parseInt(layoutData.split(',')[1])
                            }),
                            header: new NumericHeader({
                                title: title,
                                number: value,
                                state: state,
                                iconSrc: icon,
                                trend: "Up",
                                press: this.onKPICardPress.bind(this)
                            })
                        });
                    },

                    // Create Charts Panel
                    createChartsPanel: function() {
                        return new Panel("chartsPanel", {
                            headerText: "Analytics & Trends",
                            class: "sapUiMediumMargin",
                            content: [
                                new HBox({
                                    items: [
                                        this.createSuccessRateChart(),
                                        this.createPerformanceChart()
                                    ],
                                    class: "sapUiMediumMargin"
                                })
                            ]
                        });
                    },

                    // Create Success Rate Chart
                    createSuccessRateChart: function() {
                        const oVizFrame = new VizFrame("successChart", {
                            width: "100%",
                            height: "300px",
                            vizType: "line",
                            uiConfig: {
                                applicationSet: "fiori"
                            }
                        });

                        const oDataset = new FlattenedDataset({
                            dimensions: [new DimensionDefinition({ name: "Date", value: "{date}" })],
                            measures: [new MeasureDefinition({ name: "Success Rate", value: "{successRate}" })],
                            data: {
                                path: "/chartData/successRate"
                            }
                        });

                        oVizFrame.setDataset(oDataset);
                        oVizFrame.addFeed(new FeedItem({ uid: "categoryAxis", type: "Dimension", values: ["Date"] }));
                        oVizFrame.addFeed(new FeedItem({ uid: "valueAxis", type: "Measure", values: ["Success Rate"] }));

                        return new Card({
                            width: "48%",
                            class: "sapUiTinyMargin",
                            header: new Header({ title: "Success Rate Trend (7 Days)" }),
                            content: [oVizFrame]
                        });
                    },

                    // Create Performance Chart
                    createPerformanceChart: function() {
                        const oVizFrame = new VizFrame("performanceChart", {
                            width: "100%",
                            height: "300px",
                            vizType: "column",
                            uiConfig: {
                                applicationSet: "fiori"
                            }
                        });

                        const oDataset = new FlattenedDataset({
                            dimensions: [new DimensionDefinition({ name: "Component", value: "{component}" })],
                            measures: [new MeasureDefinition({ name: "Avg Duration", value: "{duration}" })],
                            data: {
                                path: "/testGroups"
                            }
                        });

                        oVizFrame.setDataset(oDataset);
                        oVizFrame.addFeed(new FeedItem({ uid: "categoryAxis", type: "Dimension", values: ["Component"] }));
                        oVizFrame.addFeed(new FeedItem({ uid: "valueAxis", type: "Measure", values: ["Avg Duration"] }));

                        return new Card({
                            width: "48%",
                            class: "sapUiTinyMargin",
                            header: new Header({ title: "Performance by Component" }),
                            content: [oVizFrame]
                        });
                    },

                    // Create advanced test groups panel
                    createAdvancedTestGroupsPanel: function() {
                        return new Panel("advancedTestGroupsPanel", {
                            headerText: "Test Components Control Center",
                            class: "sapUiMediumMargin",
                            headerToolbar: new Toolbar({
                                content: [
                                    new Title({ text: "Test Components Control Center", level: "H4" }),
                                    new ToolbarSpacer(),
                                    new ComboBox({
                                        items: [
                                            new Item({ key: "all", text: "All Environments" }),
                                            new Item({ key: "dev", text: "Development" }),
                                            new Item({ key: "test", text: "Test" }),
                                            new Item({ key: "prod", text: "Production" })
                                        ],
                                        selectedKey: "all",
                                        change: this.onEnvironmentFilter.bind(this)
                                    }),
                                    new Button({
                                        text: "Bulk Actions",
                                        icon: "sap-icon://multiselect-all",
                                        press: this.onBulkActions.bind(this)
                                    })
                                ]
                            }),
                            content: [
                                new Table({
                                    growing: true,
                                    growingThreshold: 10,
                                    mode: "MultiSelect",
                                    columns: [
                                        new Column({ header: new Label({ text: "Component" }), width: "15%" }),
                                        new Column({ header: new Label({ text: "Test Group" }), width: "20%" }),
                                        new Column({ header: new Label({ text: "Status" }), width: "10%" }),
                                        new Column({ header: new Label({ text: "Coverage" }), width: "10%" }),
                                        new Column({ header: new Label({ text: "Last Run" }), width: "15%" }),
                                        new Column({ header: new Label({ text: "Duration" }), width: "10%" }),
                                        new Column({ header: new Label({ text: "Actions" }), width: "20%" })
                                    ],
                                    items: {
                                        path: "/testGroups",
                                        template: new ColumnListItem({
                                            cells: [
                                                new Text({ 
                                                    text: "{component}",
                                                    wrapping: false
                                                }),
                                                new HBox({
                                                    items: [
                                                        new sap.ui.core.Icon({
                                                            src: "{icon}",
                                                            class: "sapUiTinyMarginEnd",
                                                            color: {
                                                                path: "status",
                                                                formatter: function(status) {
                                                                    switch(status) {
                                                                        case "Success": return "#107e3e";
                                                                        case "Warning": return "#df6e0c";
                                                                        case "Error": return "#bb0000";
                                                                        default: return "#0070f2";
                                                                    }
                                                                }
                                                            }
                                                        }),
                                                        new VBox({
                                                            items: [
                                                                new Text({ text: "{name}", class: "sapMTextBold" }),
                                                                new Text({ text: "Last: {lastRun}", class: "sapMTextSmall" })
                                                            ]
                                                        })
                                                    ]
                                                }),
                                                new ObjectStatus({
                                                    text: "{status}",
                                                    state: {
                                                        path: "status",
                                                        formatter: function(status) {
                                                            switch(status) {
                                                                case "Success": return "Success";
                                                                case "Warning": return "Warning";
                                                                case "Error": return "Error";
                                                                default: return "Information";
                                                            }
                                                        }
                                                    },
                                                    icon: {
                                                        path: "status",
                                                        formatter: function(status) {
                                                            switch(status) {
                                                                case "Success": return "sap-icon://status-positive";
                                                                case "Warning": return "sap-icon://status-critical";
                                                                case "Error": return "sap-icon://status-negative";
                                                                default: return "sap-icon://status-inactive";
                                                            }
                                                        }
                                                    }
                                                }),
                                                new VBox({
                                                    items: [
                                                        new ProgressIndicator({
                                                            percentValue: "{coverage}",
                                                            displayValue: "{coverage}%",
                                                            state: {
                                                                path: "coverage",
                                                                formatter: function(coverage) {
                                                                    return coverage >= 90 ? "Success" : coverage >= 70 ? "Warning" : "Error";
                                                                }
                                                            },
                                                            width: "80px"
                                                        })
                                                    ]
                                                }),
                                                new Text({ 
                                                    text: {
                                                        path: "lastRun",
                                                        formatter: function(date) {
                                                            return new Date(date).toLocaleString();
                                                        }
                                                    },
                                                    class: "sapMTextSmall"
                                                }),
                                                new VBox({
                                                    items: [
                                                        new Text({ 
                                                            text: "{duration}ms",
                                                            class: "sapMTextBold"
                                                        }),
                                                        new ObjectStatus({
                                                            text: {
                                                                path: "duration",
                                                                formatter: function(duration) {
                                                                    return duration < 1000 ? "Fast" : duration < 2000 ? "Normal" : "Slow";
                                                                }
                                                            },
                                                            state: {
                                                                path: "duration",
                                                                formatter: function(duration) {
                                                                    return duration < 1000 ? "Success" : duration < 2000 ? "Information" : "Warning";
                                                                }
                                                            }
                                                        })
                                                    ]
                                                }),
                                                new HBox({
                                                    items: [
                                                        new Button({
                                                            text: "Run",
                                                            type: "Emphasized",
                                                            icon: "sap-icon://play",
                                                            tooltip: "Run test group",
                                                            press: function(oEvent) {
                                                                const oBindingContext = oEvent.getSource().getBindingContext();
                                                                const sGroupKey = oBindingContext.getProperty("key");
                                                                TestManagerController.onRunGroup(sGroupKey);
                                                            }
                                                        }),
                                                        new MenuButton({
                                                            icon: "sap-icon://action",
                                                            tooltip: "More actions",
                                                            menu: new Menu({
                                                                items: [
                                                                    new MenuItem({ text: "View Details", icon: "sap-icon://detail-view" }),
                                                                    new MenuItem({ text: "Run Individual Tests", icon: "sap-icon://list" }),
                                                                    new MenuItem({ text: "View History", icon: "sap-icon://history" }),
                                                                    new MenuItem({ text: "Export Report", icon: "sap-icon://download" }),
                                                                    new MenuItem({ text: "Schedule", icon: "sap-icon://appointment-2" })
                                                                ]
                                                            })
                                                        })
                                                    ]
                                                })
                                            ]
                                        })
                                    }
                                })
                            ]
                        });
                    },

                    // Create enhanced test runs panel
                    createEnhancedTestRunsPanel: function() {
                        return new Panel("enhancedTestRunsPanel", {
                            headerText: "Test Execution History & Analytics",
                            class: "sapUiMediumMargin",
                            headerToolbar: new Toolbar({
                                content: [
                                    new Title({ text: "Test Execution History & Analytics", level: "H4" }),
                                    new ToolbarSpacer(),
                                    new DatePicker({
                                        placeholder: "Filter by date",
                                        change: this.onDateFilter.bind(this)
                                    }),
                                    new ComboBox({
                                        placeholder: "Filter by status",
                                        items: [
                                            new Item({ key: "all", text: "All Status" }),
                                            new Item({ key: "completed", text: "Completed" }),
                                            new Item({ key: "failed", text: "Failed" }),
                                            new Item({ key: "running", text: "Running" })
                                        ],
                                        change: this.onStatusFilter.bind(this)
                                    }),
                                    new Button({
                                        text: "Export",
                                        icon: "sap-icon://excel-attachment",
                                        press: this.onExportTestRuns.bind(this)
                                    })
                                ]
                            }),
                            content: [
                                new Table({
                                    growing: true,
                                    growingThreshold: 20,
                                    alternateRowColors: true,
                                    fixedLayout: false,
                                    columns: [
                                        new Column({ header: new Label({ text: "Run Information" }), width: "20%" }),
                                        new Column({ header: new Label({ text: "Environment" }), width: "10%" }),
                                        new Column({ header: new Label({ text: "Execution Details" }), width: "25%" }),
                                        new Column({ header: new Label({ text: "Results" }), width: "20%" }),
                                        new Column({ header: new Label({ text: "Performance" }), width: "15%" }),
                                        new Column({ header: new Label({ text: "Actions" }), width: "10%" })
                                    ],
                                    items: {
                                        path: "/testRuns",
                                        template: new ColumnListItem({
                                            cells: [
                                                new VBox({
                                                    items: [
                                                        new Text({ 
                                                            text: "{run_id}",
                                                            class: "sapMTextBold"
                                                        }),
                                                        new Text({ 
                                                            text: {
                                                                path: "start_time",
                                                                formatter: function(date) {
                                                                    return new Date(date).toLocaleString();
                                                                }
                                                            },
                                                            class: "sapMTextSmall"
                                                        })
                                                    ]
                                                }),
                                                new ObjectStatus({
                                                    text: "{environment}",
                                                    state: {
                                                        path: "environment",
                                                        formatter: function(env) {
                                                            switch(env) {
                                                                case "production": return "Error";
                                                                case "test": return "Success";
                                                                case "integration": return "Warning";
                                                                default: return "Information";
                                                            }
                                                        }
                                                    },
                                                    icon: "sap-icon://instance"
                                                }),
                                                new VBox({
                                                    items: [
                                                        new HBox({
                                                            items: [
                                                                new sap.ui.core.Icon({
                                                                    src: "sap-icon://time-overtime",
                                                                    class: "sapUiTinyMarginEnd"
                                                                }),
                                                                new Text({ 
                                                                    text: "{duration_ms}ms",
                                                                    class: "sapMTextBold"
                                                                })
                                                            ]
                                                        }),
                                                        new ObjectStatus({
                                                            text: "{status}",
                                                            state: {
                                                                path: "status",
                                                                formatter: function(status) {
                                                                    return status === "completed" ? "Success" : "Error";
                                                                }
                                                            },
                                                            icon: {
                                                                path: "status",
                                                                formatter: function(status) {
                                                                    return status === "completed" ? "sap-icon://status-positive" : "sap-icon://status-negative";
                                                                }
                                                            }
                                                        })
                                                    ]
                                                }),
                                                new VBox({
                                                    items: [
                                                        new HBox({
                                                            items: [
                                                                new Text({ text: "Passed: ", class: "sapMTextBold" }),
                                                                new Text({ text: "{passed_tests}", class: "sapMTextSuccess" }),
                                                                new Text({ text: " / ", class: "sapMText" }),
                                                                new Text({ text: "{total_tests}", class: "sapMText" })
                                                            ]
                                                        }),
                                                        new ProgressIndicator({
                                                            percentValue: {
                                                                parts: ["passed_tests", "total_tests"],
                                                                formatter: function(passed, total) {
                                                                    return total > 0 ? Math.round((passed / total) * 100) : 0;
                                                                }
                                                            },
                                                            displayValue: {
                                                                parts: ["passed_tests", "total_tests"],
                                                                formatter: function(passed, total) {
                                                                    return total > 0 ? Math.round((passed / total) * 100) + "%" : "0%";
                                                                }
                                                            },
                                                            state: {
                                                                parts: ["passed_tests", "total_tests"],
                                                                formatter: function(passed, total) {
                                                                    const percentage = total > 0 ? (passed / total) * 100 : 0;
                                                                    return percentage === 100 ? "Success" : percentage >= 80 ? "Warning" : "Error";
                                                                }
                                                            },
                                                            width: "100px"
                                                        })
                                                    ]
                                                }),
                                                new VBox({
                                                    items: [
                                                        new ObjectStatus({
                                                            text: {
                                                                path: "duration_ms",
                                                                formatter: function(duration) {
                                                                    return duration < 60000 ? "Fast" : duration < 180000 ? "Normal" : "Slow";
                                                                }
                                                            },
                                                            state: {
                                                                path: "duration_ms",
                                                                formatter: function(duration) {
                                                                    return duration < 60000 ? "Success" : duration < 180000 ? "Information" : "Warning";
                                                                }
                                                            },
                                                            icon: "sap-icon://performance"
                                                        }),
                                                        new Text({ 
                                                            text: {
                                                                path: "duration_ms",
                                                                formatter: function(duration) {
                                                                    return Math.round(duration / 1000) + "s";
                                                                }
                                                            },
                                                            class: "sapMTextSmall"
                                                        })
                                                    ]
                                                }),
                                                new MenuButton({
                                                    icon: "sap-icon://action",
                                                    tooltip: "Run actions",
                                                    menu: new Menu({
                                                        items: [
                                                            new MenuItem({ 
                                                                text: "View Details", 
                                                                icon: "sap-icon://detail-view",
                                                                press: function(oEvent) {
                                                                    const oBindingContext = oEvent.getSource().getParent().getParent().getBindingContext();
                                                                    const sRunId = oBindingContext.getProperty("run_id");
                                                                    TestManagerController.onViewRunDetails(sRunId);
                                                                }
                                                            }),
                                                            new MenuItem({ text: "Download Report", icon: "sap-icon://download" }),
                                                            new MenuItem({ text: "Compare", icon: "sap-icon://compare" }),
                                                            new MenuItem({ text: "Re-run", icon: "sap-icon://restart" }),
                                                            new MenuItem({ text: "Share", icon: "sap-icon://share" })
                                                        ]
                                                    })
                                                })
                                            ]
                                        })
                                    }
                                })
                            ]
                        });
                    },

                    // Event Handlers
                    onRunAllTests: function() {
                        this.showBusyIndicator("Running all test groups...");
                        
                        this.callTestAPI('run-all').then((result) => {
                            this.hideBusyIndicator();
                            if (result.success) {
                                MessageToast.show("All tests completed successfully!");
                                this.loadTestData();
                            } else {
                                MessageBox.error("Some tests failed. Check the results for details.");
                                this.loadTestData();
                            }
                        }).catch((error) => {
                            this.hideBusyIndicator();
                            MessageBox.error("Failed to run tests: " + error.message);
                        });
                    },

                    onRunGroup: function(groupKey) {
                        this.showBusyIndicator(`Running ${groupKey} tests...`);
                        
                        this.callTestAPI(`run-group/${groupKey}`).then((result) => {
                            this.hideBusyIndicator();
                            if (result.success) {
                                MessageToast.show(`${groupKey} tests completed successfully!`);
                                this.loadTestData();
                            } else {
                                MessageBox.error(`${groupKey} tests failed: ${result.error || 'Unknown error'}`);
                            }
                        }).catch((error) => {
                            this.hideBusyIndicator();
                            MessageBox.error("Failed to run group tests: " + error.message);
                        });
                    },

                    onViewStatistics: function() {
                        this.callTestAPI('statistics').then((stats) => {
                            const message = `Test Statistics (Last 7 days):
                            
Total Runs: ${stats.stats.total_runs}
Average Duration: ${Math.round(stats.stats.avg_duration / 1000)}s
Average Coverage: ${Math.round(stats.stats.avg_coverage)}%
Success Rate: ${Math.round((stats.stats.successful_runs / stats.stats.total_runs) * 100)}%
Total Tests Executed: ${stats.stats.total_tests_executed}
Total Tests Passed: ${stats.stats.total_tests_passed}`;

                            MessageBox.information(message, {
                                title: "Test Statistics"
                            });
                        });
                    },

                    onViewGroupDetails: function(groupKey) {
                        MessageBox.information(`Detailed view for ${groupKey} test group would show:
                        
• Individual test results
• Performance metrics
• Error details
• Historical trends
• Test coverage information`, {
                            title: `${groupKey} Test Group Details`
                        });
                    },

                    onViewRunDetails: function(runId) {
                        MessageBox.information(`Detailed view for run ${runId} would show:
                        
• Test execution timeline
• Individual test results
• Performance metrics
• Error logs and stack traces
• Environment information
• Coverage reports`, {
                            title: `Test Run Details: ${runId}`
                        });
                    },

                    onRefresh: function() {
                        this.loadTestData();
                        this.loadChartData();
                        MessageToast.show("Data refreshed from real-time sources");
                    },

                    // Create footer toolbar
                    createFooterToolbar: function() {
                        return new Bar({
                            contentLeft: [
                                new Text({ text: "Last Updated: " + new Date().toLocaleString() })
                            ],
                            contentMiddle: [
                                new Text({ text: "Real-time monitoring active" })
                            ],
                            contentRight: [
                                new Button({ text: "Settings", icon: "sap-icon://action-settings", press: this.onSettings.bind(this) }),
                                new Button({ text: "Help", icon: "sap-icon://question-mark", press: this.onHelp.bind(this) })
                            ]
                        });
                    },

                    // Real API Calls only - no mock data
                    callTestAPI: function(endpoint, data) {
                        const token = localStorage.getItem('a2a_token');
                        const baseUrl = window.A2A_CONFIG?.api?.test || '/api/test';
                        
                        const headers = {
                            'Content-Type': 'application/json',
                            'Accept': 'application/json'
                        };
                        
                        if (token) {
                            headers['Authorization'] = `Bearer ${token}`;
                        }
                        
                        const fetchOptions = {
                            method: data ? 'POST' : 'GET',
                            headers: headers
                        };
                        
                        if (data) {
                            fetchOptions.body = JSON.stringify(data);
                        }
                        
                        return fetch(`${baseUrl}/${endpoint}`, fetchOptions)
                            .then(response => {
                                if (!response.ok) {
                                    if (response.status === 401) {
                                        // Token expired, redirect to login
                                        window.location.href = '/login.html?returnUrl=' + encodeURIComponent(window.location.href);
                                        throw new Error('Authentication required');
                                    }
                                    throw new Error(`API request failed: ${response.status} ${response.statusText}`);
                                }
                                return response.json();
                            });
                    },

                    // Load test data from real backend only
                    loadTestData: function() {
                        this.showBusyIndicator("Loading test data...");
                        
                        // Load all data in parallel
                        Promise.all([
                            this.callTestAPI('runs/recent'),
                            this.callTestAPI('groups'),
                            this.callTestAPI('analytics/charts')
                        ])
                        .then(([runsData, groupsData, chartData]) => {
                            this.hideBusyIndicator();
                            this.oModel.setProperty("/testRuns", runsData.runs || []);
                            this.oModel.setProperty("/statistics", runsData.statistics || this.getEmptyStats());
                            this.oModel.setProperty("/notifications", runsData.notifications || []);
                            this.oModel.setProperty("/testGroups", groupsData.groups || []);
                            this.oModel.setProperty('/chartData', {
                                successRate: chartData.successRateData || [],
                                performance: chartData.performanceData || []
                            });
                            console.log('All test data loaded from backend');
                        })
                        .catch(error => {
                            this.hideBusyIndicator();
                            console.error('Failed to load test data:', error);
                            MessageBox.error("Failed to load test data from backend: " + error.message);
                            // Set empty data
                            this.oModel.setProperty("/testRuns", []);
                            this.oModel.setProperty("/statistics", this.getEmptyStats());
                            this.oModel.setProperty("/notifications", []);
                            this.oModel.setProperty("/testGroups", []);
                            this.oModel.setProperty('/chartData', { successRate: [], performance: [] });
                        });
                    },
                    
                    getEmptyStats: function() {
                        return {
                            totalRuns: 0,
                            successRate: 0,
                            avgDuration: 0,
                            totalTests: 0,
                            totalPassed: 0,
                            avgCoverage: 0,
                            activeEnvironments: 0
                        };
                    },

                    // Load chart data from real backend only
                    loadChartData: function() {
                        this.callTestAPI('analytics/charts')
                            .then(data => {
                                this.oModel.setProperty('/chartData', {
                                    successRate: data.successRateData || [],
                                    performance: data.performanceData || []
                                });
                                console.log('Chart data loaded from backend');
                            })
                            .catch(error => {
                                console.error('Failed to load chart data:', error);
                                this.oModel.setProperty('/chartData', {
                                    successRate: [],
                                    performance: []
                                });
                            });
                    },

                    // Utility functions
                    showBusyIndicator: function(text) {
                        this.oBusyDialog = new BusyIndicator({
                            text: text,
                            size: "1rem"
                        });
                        this.oBusyDialog.open();
                    },

                    hideBusyIndicator: function() {
                        if (this.oBusyDialog) {
                            this.oBusyDialog.close();
                            this.oBusyDialog.destroy();
                        }
                    },

                    // Advanced event handlers
                    initializeWebSocket: function() {
                        // Simulate real-time WebSocket connection
                        console.log('Initializing WebSocket connection for real-time updates...');
                        // In production, this would connect to actual WebSocket endpoint
                        this.websocket = {
                            connected: true,
                            lastMessage: new Date()
                        };
                        this.oModel.setProperty('/websocket', this.websocket);
                    },

                    setupUserProfile: function() {
                        // Setup user profile and permissions
                        this.oModel.setProperty('/userProfile', this.userProfile);
                    },

                    setupAutoRefresh: function() {
                        // Auto-refresh data every 30 seconds
                        setInterval(() => {
                            if (this.oModel.getProperty('/realTimeUpdates')) {
                                this.loadTestData();
                                this.loadChartData();
                            }
                        }, 30000);
                    },

                    onKPICardPress: function(oEvent) {
                        const sTitle = oEvent.getSource().getTitle();
                        MessageBox.information(`Detailed analytics for ${sTitle} would show:

• Historical trends and patterns
• Breakdown by environment and component
• Performance metrics and benchmarks
• Predictive analytics and recommendations
• Real-time monitoring dashboard`, {
                            title: `${sTitle} Analytics`
                        });
                    },

                    onSearch: function(oEvent) {
                        const sQuery = oEvent.getParameter('query');
                        // Implement search across test runs, components, and results
                        MessageToast.show(`Searching for: ${sQuery}`);
                    },

                    onScheduleTest: function() {
                        MessageBox.information('Schedule Test Run Dialog would open here with:

• Test group selection
• Environment configuration
• Scheduling options (immediate, recurring, webhook)
• Notification settings
• Resource allocation options', {
                            title: 'Schedule Test Run'
                        });
                    },

                    onExportResults: function() {
                        MessageBox.information('Export functionality would provide:

• Excel/CSV export with detailed results
• PDF test reports
• JUnit XML for CI/CD integration
• Custom report templates
• Email distribution options', {
                            title: 'Export Test Results'
                        });
                    },

                    onConfiguration: function() {
                        MessageBox.information('Configuration panel would allow:

• Test environment settings
• Notification preferences
• User permissions management
• API endpoint configuration
• Dashboard customization', {
                            title: 'System Configuration'
                        });
                    },

                    onShowNotifications: function() {
                        const notifications = this.oModel.getProperty('/notifications');
                        if (notifications.length === 0) {
                            MessageToast.show('No new notifications');
                        } else {
                            MessageBox.information(`You have ${notifications.length} notifications:

` +
                                notifications.map(n => `• ${n.title}`).join('\n'), {
                                title: 'Notifications'
                            });
                        }
                    },

                    onEnvironmentFilter: function(oEvent) {
                        const sSelectedKey = oEvent.getParameter('selectedItem').getKey();
                        MessageToast.show(`Filtering by environment: ${sSelectedKey}`);
                        // Implement actual filtering logic
                    },

                    onBulkActions: function() {
                        MessageBox.information('Bulk Actions would include:

• Run selected test groups
• Export multiple test results
• Schedule multiple test runs
• Update configuration for multiple components
• Send notifications to stakeholders', {
                            title: 'Bulk Actions'
                        });
                    },

                    onDateFilter: function(oEvent) {
                        const dDate = oEvent.getSource().getDateValue();
                        MessageToast.show(`Filtering by date: ${dDate ? dDate.toDateString() : 'All dates'}`);
                    },

                    onStatusFilter: function(oEvent) {
                        const sSelectedKey = oEvent.getParameter('selectedItem').getKey();
                        MessageToast.show(`Filtering by status: ${sSelectedKey}`);
                    },

                    onExportTestRuns: function() {
                        MessageToast.show('Exporting test runs to Excel...');
                        // Simulate export functionality
                    },

                    onSettings: function() {
                        MessageBox.information('Settings panel would include:

• Dashboard layout preferences
• Notification settings
• Data refresh intervals
• Theme selection
• Language preferences
• Export templates', {
                            title: 'Settings'
                        });
                    },

                    onHelp: function() {
                        MessageBox.information('Help resources:

• User Guide and Documentation
• Video Tutorials
• API Documentation
• Best Practices Guide
• Contact Support
• Feature Request Portal', {
                            title: 'Help & Support'
                        });
                    }
                };

                // Initialize the application with enterprise features
                TestManagerController.onInit();
                TestManagerController.loadChartData();
                
                // Simulate real-time updates
                setTimeout(() => {
                    TestManagerController.oModel.setProperty('/realTimeUpdates', true);
                    console.log('✅ Real-time monitoring activated');
                }, 2000);
            });
        });
    </script>

    <style>
        html, body, #content {
            height: 100%;
            margin: 0;
            font-family: "72", "72full", Arial, Helvetica, sans-serif;
        }

        /* SAP Enterprise Styling */
        .sapUiMediumMargin {
            margin: 1rem !important;
        }

        .sapUiTinyMargin {
            margin: 0.5rem !important;
        }

        .sapUiTinyMarginEnd {
            margin-right: 0.5rem !important;
        }

        /* Enhanced SAP Fiori 3.0 Styling */
        .sapFCard {
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            border: 1px solid #e5e5e5;
            border-radius: 8px;
            transition: box-shadow 0.2s ease;
        }
        
        .sapFCard:hover {
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
        }
        
        .kpiCard {
            background: linear-gradient(135deg, #ffffff 0%, #fafafa 100%);
        }
        
        .kpiCard .sapFCardHeader {
            border-bottom: 2px solid #0070f2;
        }
        
        /* Advanced table styling */
        .sapMTable {
            border: 1px solid #e5e5e5;
            border-radius: 4px;
        }
        
        .sapMListTbl tbody > .sapMLIB:nth-child(even) {
            background-color: #fafafa;
        }
        
        .sapMListTbl tbody > .sapMLIB:hover {
            background-color: #f0f8ff;
            cursor: pointer;
        }

        /* Status colors */
        .sapMObjectStatus.sapMObjectStatusSuccess {
            color: #107e3e;
        }

        .sapMObjectStatus.sapMObjectStatusError {
            color: #bb0000;
        }

        .sapMObjectStatus.sapMObjectStatusWarning {
            color: #df6e0c;
        }

        /* Progress indicator */
        .sapMPI {
            margin: 1rem 0;
        }

        /* Table styling */
        .sapMTable {
            border: 1px solid #e5e5e5;
        }

        /* Button spacing */
        .sapMBtn {
            margin-right: 0.5rem;
        }

        .sapMBtn:last-child {
            margin-right: 0;
        }

        /* Title styling */
        .sapMTitle {
            color: #32363a;
            font-weight: bold;
        }

        /* Enhanced Panel styling */
        .sapMPanel {
            border: 1px solid #e5e5e5;
            background: #ffffff;
            border-radius: 8px;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.08);
            margin-bottom: 1rem;
        }

        .sapMPanel > .sapMPanelContent {
            background: white;
            border-radius: 0 0 8px 8px;
        }
        
        .sapMPanel > .sapMPanelHdr {
            background: linear-gradient(90deg, #0070f2 0%, #005cbf 100%);
            color: white;
            border-radius: 8px 8px 0 0;
            padding: 1rem;
        }
        
        .sapMPanel .sapMPanelHdrText {
            color: white;
            font-weight: 600;
        }
        
        /* Real-time indicators */
        .realTimeIndicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            background-color: #107e3e;
            border-radius: 50%;
            animation: pulse 2s infinite;
            margin-left: 0.5rem;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        /* Success/Error state colors */
        .sapMTextSuccess {
            color: #107e3e !important;
            font-weight: 600;
        }
        
        .sapMTextError {
            color: #bb0000 !important;
            font-weight: 600;
        }
        
        .sapMTextWarning {
            color: #df6e0c !important;
            font-weight: 600;
        }
        
        .sapMTextBold {
            font-weight: 600;
        }
        
        .sapMTextSmall {
            font-size: 0.875rem;
            color: #666;
        }
        
        /* Enterprise dashboard specific */
        .enterpriseDashboard {
            background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
            min-height: 100vh;
        }
        
        /* Toolbar enhancements */
        .sapMTB {
            background: rgba(0, 112, 242, 0.05);
            border-bottom: 2px solid #0070f2;
        }
        
        /* VizFrame container styling */
        .sapVizFrame {
            background: white;
            border-radius: 4px;
        }
        
        /* Grid container responsive styling */
        .sapFGridContainer {
            padding: 1rem;
        }
        
        /* Status indicator animations */
        .sapMObjectStatus {
            transition: all 0.3s ease;
        }
        
        .sapMObjectStatus:hover {
            transform: scale(1.05);
        }
        
        /* Loading enhancement */
        .sapUiLocalBusyIndicator {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(2px);
        }
    </style>
</head>
<body class="sapUiBody" id="content">
    <!-- Application content will be rendered here -->
    <div id="loading" style="
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        text-align: center;
        font-family: '72', Arial, sans-serif;
    ">
        <div style="margin-bottom: 1rem;">
            <div style="
                width: 40px;
                height: 40px;
                border: 4px solid #f3f3f3;
                border-top: 4px solid #0070f2;
                border-radius: 50%;
                animation: spin 1s linear infinite;
                margin: 0 auto;
            "></div>
        </div>
        <div style="color: #32363a; font-size: 1.125rem;">Loading A2A Test Manager...</div>
    </div>

    <style>
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        #loading {
            z-index: 9999;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(4px);
        }

        .sapUiBody #loading {
            display: none;
        }
        
        /* Mobile responsiveness */
        @media (max-width: 768px) {
            .sapFGridContainer {
                padding: 0.5rem;
            }
            
            .kpiCard {
                margin: 0.25rem;
            }
            
            .sapMTable .sapMListTbl {
                font-size: 0.875rem;
            }
        }
        
        /* High contrast mode support */
        @media (prefers-contrast: high) {
            .sapFCard {
                border: 2px solid #000;
            }
            
            .sapMPanel {
                border: 2px solid #000;
            }
        }
        
        /* Dark mode support */
        @media (prefers-color-scheme: dark) {
            .enterpriseDashboard {
                background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            }
            
            .sapFCard {
                background: #2d2d2d;
                border-color: #404040;
            }
            
            .sapMPanel {
                background: #2d2d2d;
                border-color: #404040;
            }
        }
    </style>
</body>
</html>