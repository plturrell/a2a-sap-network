_schema-version: "3.3"
ID: a2a-agent-platform-staging
extends: a2a-agent-platform

# Staging environment specific parameters
parameters:
  app-name: a2a-agents-staging
  service-name: a2a-staging
  log-level: info
  hana-plan: schema
  postgres-plan: standard
  redis-plan: standard
  ans-plan: standard

# Module overrides for staging
modules:
  - name: a2a-backend
    parameters:
      instances: 2
      memory: 2048M
      disk-quota: 2048M
      health-check-type: http
      health-check-http-endpoint: /health
      health-check-timeout: 60
    properties:
      NODE_ENV: staging
      DEBUG: false
      ENABLE_PROFILING: true
      ENABLE_SWAGGER: true
      CORS_ALLOWED_ORIGINS: "https://*.staging.company.com"
      DATABASE_POOL_MIN: 5
      DATABASE_POOL_MAX: 20
      RATE_LIMIT_ENABLED: true
      RATE_LIMIT_WINDOW_MS: 60000
      RATE_LIMIT_MAX_REQUESTS: 1000
      CACHE_TTL: 1800
      ENABLE_METRICS: true
      METRICS_PORT: 9090
    env:
      GROK_API_URL: https://api.x.ai/v1/chat/completions
      PERPLEXITY_API_URL: https://api.perplexity.ai
      ENABLE_MOCK_SERVICES: false
      SENTRY_DSN: ${sentry-dsn-staging}
      SENTRY_ENVIRONMENT: staging

  - name: a2a-frontend
    parameters:
      memory: 256M
    build-parameters:
      commands:
        - npm install
        - npm run build:staging
    env:
      SAP_UI5_VERSION: 1.120.0
      ENABLE_DEBUG_MODE: false
      ENABLE_ANALYTICS: true
      ANALYTICS_ID: ${analytics-id-staging}

  - name: a2a-approuter
    parameters:
      instances: 2
      memory: 256M
      routes:
        - route: staging-${app-name}.${default-domain}
    properties:
      SESSION_TIMEOUT: 1800
      ENABLE_CORS: false
      LOG_REMOTE_USER: true
      COMPRESSION: true
      SECURE_SESSION_COOKIE: true
    env:
      NODE_ENV: staging

  - name: a2a-db-deployer
    parameters:
      no-route: true
      health-check-type: none
      tasks:
        - name: deploy-db
          command: npm run deploy
          memory: 512M
          disk-quota: 1024M

# Staging-specific resources
resources:
  - name: a2a-hana-hdi
    properties:
      enable-debug: false
      max-connections: 100
      statement-timeout: 30000

  - name: a2a-postgres-db
    parameters:
      config:
        max_connections: 100
        shared_buffers: 256MB
        effective_cache_size: 1GB
        maintenance_work_mem: 64MB
        checkpoint_completion_target: 0.9
        wal_buffers: 16MB
        default_statistics_target: 100
        random_page_cost: 1.1
        effective_io_concurrency: 200

  - name: a2a-redis
    parameters:
      config:
        maxmemory: 1gb
        maxmemory-policy: allkeys-lru
        timeout: 600
        tcp-keepalive: 60
        tcp-backlog: 511
        databases: 16

  - name: a2a-xsuaa
    parameters:
      config:
        foreign-scope-references:
          - $ACCEPT_GRANTED_SCOPES
        oauth2-configuration:
          token-validity: 1800
          refresh-token-validity: 43200
          system-attributes:
            - rolecollections
            - groups
          credential-types:
            - binding-secret
            - x509
            - instance-secret

  - name: a2a-ans
    parameters:
      config:
        configuration:
          actions:
            - name: email-staging
              type: EMAIL
              properties:
                destination: staging-alerts@company.com
            - name: slack-staging
              type: WEBHOOK
              properties:
                url: ${slack-webhook-staging}